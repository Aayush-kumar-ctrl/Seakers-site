<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sneaker Store ðŸ‘Ÿ</title>

    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f7f7f7;
        text-align: center;
        padding: 50px;
      }

      h1 {
        color: #222;
        margin-bottom: 30px;
      }

      button {
        padding: 10px 20px;
        margin: 10px;
        border: none;
        background-color: #111;
        color: #fff;
        border-radius: 6px;
        cursor: pointer;
        transition: 0.3s;
      }

      button:hover {
        background-color: #555;
      }

      #user-info {
        margin-top: 30px;
        font-size: 18px;
        color: #333;
      }
    </style>

    <!-- âœ… Clerk frontend SDK -->
    <script
      async
      crossorigin="anonymous"
      src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
    ></script>
  </head>

  <body>
    <h1>Welcome to Sneaker Store ðŸ‘Ÿ</h1>

    <!-- Buttons for login/signup -->
    <button id="sign-in">Sign In</button>
    <button id="sign-up">Sign Up</button>
    <button id="sign-out" style="display: none">Sign Out</button>
    <button
      class="add-to-cart"
      data-id="PRODUCT_ID_HERE"
      data-name="PRODUCT_NAME_HERE"
      data-price="PRODUCT_PRICE_HERE"
    >
      Add to Cart
    </button>

    <div id="user-info"></div>

    <!-- âœ… Clerk initialization -->
    <script>
      window.addEventListener("load", async () => {
        await Clerk.load();

        const signInButton = document.getElementById("sign-in");
        const signUpButton = document.getElementById("sign-up");
        const signOutButton = document.getElementById("sign-out");
        const userInfo = document.getElementById("user-info");

        // Update UI when user signs in or out
        function updateUI() {
          const user = Clerk.user;

          if (user) {
            signInButton.style.display = "none";
            signUpButton.style.display = "none";
            signOutButton.style.display = "inline-block";
            userInfo.textContent = `ðŸ‘‹ Welcome, ${user.firstName || "User"}!`;
          } else {
            signInButton.style.display = "inline-block";
            signUpButton.style.display = "inline-block";
            signOutButton.style.display = "none";
            userInfo.textContent = "";
          }
        }

        // Sign In
        signInButton.addEventListener("click", () => {
          Clerk.openSignIn();
        });

        // Sign Up
        signUpButton.addEventListener("click", () => {
          Clerk.openSignUp();
        });

        // Sign Out
        signOutButton.addEventListener("click", async () => {
          await Clerk.signOut();
          updateUI();
        });

        Clerk.addListener(updateUI);
        updateUI();
      });
    </script>

    <section class="collection" id="collection">
      <h2 class="section-title">Featured Collection</h2>
      <div class="products" id="products-container">
        <!-- Products will be inserted here dynamically -->
      </div>
    </section>

    <script>
      async function loadProducts() {
        try {
          const res = await fetch("http://localhost:5000/api/products");
          const products = await res.json();

          const container = document.getElementById("products-container");
          container.innerHTML = ""; // clear any existing

          products.forEach((product) => {
            const card = document.createElement("div");
            card.className = "product-card";
            card.innerHTML = `
          <img src="${product.image}" alt="${product.name}" />
          <h3>${product.name}</h3>
          <p class="price">â‚¹${product.price}</p>
        `;
            container.appendChild(card);
          });
        } catch (err) {
          console.error("Failed to load products:", err);
        }
      }

      loadProducts();
    </script>
    <h2>Your Cart</h2>
    <div id="cart-container"></div>

    <script>
      let userCart = [];

      async function loadCart() {
        try {
          // Only fetch cart if user is logged in
          const res = await fetch("http://localhost:5000/api/cart", {
            credentials: "include",
          });
          const cart = await res.json();
          userCart = cart.items || [];
          renderCart();
        } catch (err) {
          console.error("Failed to load cart:", err);
        }
      }

      function renderCart() {
        const container = document.getElementById("cart-container");
        container.innerHTML = "";
        if (userCart.length === 0) {
          container.textContent = "Cart is empty";
          return;
        }

        userCart.forEach((item) => {
          const div = document.createElement("div");
          div.textContent = `${item.name} - â‚¹${item.price} Ã— ${item.quantity}`;
          container.appendChild(div);
        });
      }

      document.addEventListener("click", async (e) => {
        if (e.target.classList.contains("add-to-cart")) {
          if (!window.clerk || !clerk.auth.user) {
            alert("Please sign in first!");
            return;
          }

          const productId = e.target.dataset.id;
          const name = e.target.dataset.name;
          const price = Number(e.target.dataset.price);

          try {
            await fetch("http://localhost:5000/api/cart", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify({ productId, name, price, quantity: 1 }),
            });

            await loadCart();
            alert(`${name} added to cart!`);
          } catch (err) {
            console.error("Failed to add to cart:", err);
          }
        }
      });

      // Load cart on page load if user is logged in
      loadCart();
    </script>
  </body>
</html>
